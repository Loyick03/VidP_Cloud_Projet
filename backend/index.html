<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VidP - Dashboard IA</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #141414; color: #fff; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        /* SIDEBAR (PLAYLIST) */
        .sidebar { width: 320px; background: #1f1f1f; border-right: 1px solid #333; display: flex; flex-direction: column; }
        .sidebar-header { padding: 20px; font-size: 1.2rem; font-weight: bold; color: #4CAF50; border-bottom: 1px solid #333; letter-spacing: 1px; }
        .video-list { list-style: none; padding: 0; margin: 0; overflow-y: auto; flex: 1; }
        .video-item { padding: 15px 20px; border-bottom: 1px solid #333; cursor: pointer; transition: 0.2s; }
        .video-item:hover { background: #333; }
        .video-item.active { background: #4CAF50; color: white; border-left: 4px solid #fff; }
        .vid-title { font-weight: bold; display: block; margin-bottom: 4px; font-size: 0.95rem; }
        .vid-info { font-size: 0.75rem; opacity: 0.7; display: flex; justify-content: space-between; }

        /* MAIN */
        .main { flex: 1; padding: 30px; display: flex; flex-direction: column; overflow-y: auto; align-items: center; }
        .player-wrapper { width: 100%; max-width: 900px; background: #000; border-radius: 12px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        video { width: 100%; display: block; }
        
        .info-panel { width: 100%; max-width: 900px; margin-top: 20px; background: #1f1f1f; padding: 25px; border-radius: 12px; }
        h2 { margin-top: 0; color: #4CAF50; }
        .tag { background: #333; padding: 5px 10px; border-radius: 20px; margin-right: 8px; font-size: 0.9rem; border: 1px solid #444; display: inline-block; margin-bottom: 5px;}
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="sidebar-header">ðŸ“‚ HISTORIQUE VIDP</div>
        <ul id="playlist" class="video-list">
            <li style="padding:20px; text-align:center; color:#666">Chargement...</li>
        </ul>
    </div>

    <div class="main">
        <div id="welcome" style="margin-top: 100px; color: #555; text-align: center;">
            <h3>ðŸ‘ˆ SÃ©lectionnez une vidÃ©o pour commencer</h3>
        </div>

        <div id="content-area" style="display:none; width: 100%; display: flex; flex-direction: column; align-items: center;">
            <div class="player-wrapper">
                <video id="videoPlayer" controls crossorigin="anonymous">
                    <track id="subTrack" kind="subtitles" srclang="fr" label="FranÃ§ais (IA)" default>
                </video>
            </div>

            <div class="info-panel">
                <h2 id="m-title">Titre</h2>
                <p><strong>Fichier :</strong> <span id="m-filename" style="font-family: monospace; color: #bbb;">...</span></p>
                <p><strong>Langue :</strong> <span id="m-lang">...</span></p>
                <p><strong>DÃ©tections IA :</strong></p>
                <div id="m-tags"></div>
            </div>
        </div>
    </div>

    <script>
        let allData = {};

        // Convertit le SRT du JSON en WebVTT pour le lecteur
        function srtToVtt(srt) {
            return "WEBVTT\n\n" + srt.replace(/(\d{2}:\d{2}:\d{2}),(\d{3})/g, '$1.$2');
        }

        async function init() {
            try {
                const res = await fetch('/api/results');
                allData = await res.json();
                const ids = Object.keys(allData).reverse(); // Les plus rÃ©cents en haut

                const list = document.getElementById('playlist');
                list.innerHTML = "";

                if (ids.length === 0) {
                    list.innerHTML = "<li style='padding:20px'>Aucune vidÃ©o traitÃ©e.</li>";
                    return;
                }

                ids.forEach((id, index) => {
                    const vid = allData[id];
                    const date = new Date(vid.timestamp * 1000);
                    const timeStr = date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    
                    const li = document.createElement('li');
                    li.className = 'video-item';
                    li.innerHTML = `
                        <span class="vid-title">ðŸŽ¬ ${vid.video_id}</span>
                        <span class="vid-info"><span>${timeStr}</span> <span>${vid.detected_language}</span></span>
                    `;
                    li.onclick = () => loadVideo(id, li);
                    list.appendChild(li);

                    // Lance la premiÃ¨re vidÃ©o automatiquement
                    if (index === 0 && document.getElementById('content-area').style.display === 'none') {
                        loadVideo(id, li);
                    }
                });
            } catch (e) { console.error(e); }
        }

        function loadVideo(id, elem) {
            document.querySelectorAll('.video-item').forEach(e => e.classList.remove('active'));
            if(elem) elem.classList.add('active');

            document.getElementById('welcome').style.display = 'none';
            document.getElementById('content-area').style.display = 'flex';

            const data = allData[id];
            document.getElementById('m-title').innerText = "Analyse : " + data.video_id;
            document.getElementById('m-filename').innerText = data.filename;
            document.getElementById('m-lang').innerText = data.detected_language.toUpperCase();

            const tagsDiv = document.getElementById('m-tags');
            tagsDiv.innerHTML = "";
            (data.detected_objects || []).forEach(obj => {
                tagsDiv.innerHTML += `<span class="tag">âœ… ${obj}</span>`;
            });

            const player = document.getElementById('videoPlayer');
            player.src = "/static/" + data.filename;

            if (data.subtitles) {
                const vtt = srtToVtt(data.subtitles);
                const blob = new Blob([vtt], { type: "text/vtt" });
                const track = document.getElementById('subTrack');
                track.src = URL.createObjectURL(blob);
                track.mode = "showing";
            }
        }

        // Auto-refresh toutes les 5 sec pour voir les nouvelles vidÃ©os arriver
        init();
        setInterval(init, 5000);
    </script>
</body>
</html>